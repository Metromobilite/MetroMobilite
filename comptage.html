<!doctype html>
<!--
// Metromobilité is the mobile application of Grenoble Alpes Métropole <http://www.metromobilite.fr/>.
// It provides all the information and services for your travels in Grenoble agglomeration.

// Copyright (C) 2013
// Contributors:
//	NB/VT - sully-group - www.sully-group.fr - initialisation and implementation

// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as
// published by the Free Software Foundation, either version 3 of the
// License, or (at your option) any later version.

// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.

// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="fr">
  <head>
    <base href="http://www.metromobilite.fr/" />
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="initial-scale=1.0, user-scalable=no, width=device-width" name="viewport">
    <title>Comptages</title>
	<!--<meta name="description" content="" />-->
	<link href="js/lib/ol/ol.css" type="text/css" rel="stylesheet" />
    <link href="js/lib/bs/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/map.css" type="text/css" rel="Stylesheet"/>
	<link rel="icon" href="favicon.png" />
	<!--<link rel="Stylesheet" type="text/css" href="css/planTC.css"/>-->
	
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
		 <style type='text/css'>
			#panel {
				line-height: 2em;
			}
			#panel .container-fluid > div {
				display:block;
			}
			#panel .libelle {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
		#panel h1 {
			background-color: #646464;
			color:#fff;
			margin: 10px -15px;
			padding: 0px 15px;
			cursor:pointer;
			line-height:28px;
			height:36px;
			font-size:18px;
		}
		#panel h1 > div:first-of-type {
			font-weight:bold;
			max-width:80%;
			max-width:calc(100% - 50px);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			display: inline-block;
		}
		#panel h1[data-layer] .check{
			border-radius: 14px;
			box-shadow: -1px 1px 1px 1px rgba(0, 0, 0, 0.42) inset;
			height: 28px;
			padding: 2px;
			width: 46px;
			margin: 3px 0;
		}
		#panel h1[data-layer] .check .switch {
			background-color: #c0c0c0;
			border-radius: 12px;
			display: block;
			height: 24px;
			width: 24px;
			border: 2px solid #6f6f6f;
			box-shadow: -1px 3px 1px 0 rgba(0, 0, 0, 0.42);
		}
		#panel h1[data-layer].layerVisible .check {
			background-color:#50AE2F;
		}
		#panel h1[data-layer].layerVisible .check .switch {
			margin-left:18px;
		}
		#panel h1[data-layer]:hover {
			background-color: #505050;
		}
		.ol-control .glyphicon {
			top:0px;
		}
		 </style>
  </head>
  <body>
	<div id='head'></div>
	<div class="container-fluid main">
		<div class="row">
			<div id="modele" style="display:none;">
				<ul>
					<div></div>
				</ul>
			</div>
			<div id="menu" class="toggleListe pull-right" title="Affichage du panneau de sélection des éléments cartographiques" alt="Affichage du panneau de sélection des éléments cartographiques"><span class="glyphicon glyphicon-menu-hamburger"></span></div>
			<div id="map" class="map"></div>
			<div id="popup"></div>
			<div class="layerSwitcher">
				<div class="layersPanel">
					<div class="close-switcher pull-right"><span class="glyphicon glyphicon-minus"></span></div>
					<div class="pull-left">Afficher : </div><br>
					<div class="bases list-unstyled text-left"></div>
					<ul class="layers list-unstyled text-left"></ul>
				</div>
			</div>
			<div id="panel" class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
				<div class="container-fluid">
					<div id="panelContent" class="row">
						<div class="row">
							<div id="menuListe" class="toggleListe pull-right" title="Affichage du panneau de sélection des éléments cartographiques" alt="Affichage du panneau de sélection des éléments cartographiques"><span class="glyphicon glyphicon-menu-hamburger"></span></div>
						</div>
						<h1 class="row">D.I.R.</h1>
						<div class="row"><div id="DDE"></div></div>
						<h1 class="row">Metro</h1>
						<div class="row"><div id="GRE"></div></div>
						</div>
					<div class="row">
						<div class="input-group input-group-sm dropup col-xs-12 pull-left">
							<input type="text" class="form-control" id="panelFilter" placeholder="Rechercher un élément affiché"/>
							<span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="js/lib/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="js/lib/ol/ol.js"></script>
	<script type="text/javascript" src="js/lib/bs/js/moment.min.js"></script>
	<script type="text/javascript" src="js/lib/bs/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/lib/bs/js/bootstrap3-typeahead.min.js"></script>
	<script type="text/javascript" src="stats/piwik.js"></script>
	<script type="text/javascript" src="js/outils.js"></script>
	<script type="text/javascript" src="js/fr.js"></script>
	<script type="text/javascript" src="js/carte.js"></script>
	<script type="text/javascript">
		var sourcePme;
		var imagePme = new ol.style.Circle({
			radius: 6,
			fill: new ol.style.Fill({color: '#FF0000'}),
			stroke: new ol.style.Stroke({color: '#000000', width: 1})
		});
		function getStylesPme(f,res) {
			if(!styleCache['pme']) {
				styleCache['pme'] = new ol.style.Style({
					image:imagePme
				});
			}	
			return [styleCache['pme']];
		}
		
		function getLi(f) {
			if (f.getGeometry().getType() == 'Point'){
				if (f.get('visible')==false) return;
				var code =f.get('CODE');
				var partenaire = code.substr(0,3);
				var titre = f.get('LIBELLE')+' : '+code;
				var modele = $('#modele > ul > div');
				var li = modele.clone();
				li.attr('id',code).attr('title',titre.trim());
				var gauche = '<span class="col-xs-6 libelle">'+f.get('LIBELLE')+(partenaire=='DDE'?' '+code.slice(-1):'')+'</span>';
				var droite = '<span class="col-xs-2">'+f.get('Q')+'</span><span class="col-xs-2">'+f.get('T')+'</span><span class="col-xs-2">'+f.get('V')+'</span>';
				li.html(gauche+droite);
				$('#'+partenaire).append(li);
				
			}
		}
		function togglePanneau() {
			if(!$('#panel').is(':visible')) {
				$('.toggleListe').addClass('listeAffichee');
			} else {
				$('.toggleListe').removeClass('listeAffichee');
			}
			$('#panel').toggle();
		}
		function getDetails(feature) {
			if (feature.getGeometry().getType() == 'point' || feature.getGeometry().getType() == 'LineString') {
				return '';
			}
			var coord= ol.proj.transform(feature.getGeometry().getCoordinates(), sm, gg);
			var lonlat = coord[1]+','+coord[0];

			var details = feature.get('CODE')+' <br/> '+feature.get('H')+'<br/>Q : '+feature.get('Q')+'<br/>T : '+feature.get('T')+'<br/> V : '+feature.get('V');
			return details;
		}
		function initPage() {
			if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
				isMobile =true;
			}
			modififieIconMaxres();
			if (urlParams.iFrame){
				$(".main").attr('style','top:0px');
				$.support.cors = true;
				//initPlanTC();
			} else {
				$('#head').load('head.html');
			}
			initPanneau();
			initCarte();
		}
		function initPanneau(){
			$('.toggleListe').click(function(){
				togglePanneau();
			});
			$('#panel').on('click','#panelContent > div > div > div',function(e){
				var code = this.id;
				var f = sourcePme.getFeatureById(code);
				if(f) {
					getMap('map').getView().setCenter(f.getGeometry().getCoordinates());
					getMap('map').getView().setZoom(18);
					if(isTaille('xs')) togglePanneau();
				}
			});
		}
		function initCarte(){
			var idcarte = 'map';
			var map=initMap(idcarte);
			ajouteControle('map','layerSwitcher');
			
			//map.singleClickCallback = getStreetEdge;
			sourcePme = new ol.source.GeoJSON({
				projection: sm,
				url:'http://83.145.98.139:4480/data/Carto/Dynamique/dynPme.geojson'
			});
			sourcePme.on('addfeature',function(e){
				var f= e.feature;
				f.setId(f.get('CODE'));
				f.set('id',f.get('CODE'));
				f.set('detailsCallback',getDetails);
				f.set('detailsSeul',true);
				f.set('description',f.get('LIBELLE'));
				getLi(f);
			});
			var idEvt =null;
			idEvt = sourcePme.on('change', function() {
				switch (sourcePme.getState()) {
					case 'ready':
						sourcePme.unByKey(idEvt);
						tri("#DDE","div","","title");
						tri("#GRE","div","","title");
						break;
				}
			});
			var layerPme = ajouteLayerManuel('pme','map',{fctStyle:getStylesPme,detailsCallback:getDetails,source:sourcePme});
			ajouteLayerSwitcher('map','pme','.layerSwitcher',{
				libelle:'pme'
			});
			activeLayer('pme');
		}
		
		initPage();
	</script>
  </body>
</html>