<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Itineraire Velo</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="http://openlayers.org/en/v3.16.0/css/ol.css" type="text/css">
		<script src="http://openlayers.org/en/v3.16.0/build/ol.js"></script>
		<style type='text/css'>
			#map,#formulaire{
				width:50%;
				float:left;
			}
			#formulaire label{
				display: block;
				float:left;
				width:140px;
				padding-left:10px;
			}
			#hideRes:focus ~ #codeRes {
			  display: none;
			}
			#showRes:focus ~ #codeRes, #codeRes :focus {
			  display: block;
			}
			#codeRes{display:none;}

			#divRes{
				display:block;
				clear:both;
			}
			
			.white-space-pre {
				white-space: pre-wrap;
			}

		</style>
	</head>
  <body>
	<div>Exemple de Calcul d'itineraire Vélo</div>
    <div id="map" class="map"></div>
	<div id="formulaire">
		<div><label for="from">from</label><input id="from" size="38"><input id="delFrom" type=button value="X"></div>
		<div><label for="to">to</label><input id="to" size="38"><input id="delTo" type=button value="X"></div>
		<div><label for="date">date</label><input id="date" value="2016-06-03"></div>
		<div><label for="time">time</label><input id="time" value="08:30"></div>
		<div><label for="arriveBy">arriveBy</label><input id="arriveBy" value="false"></div>
		<div><label for="bikeSpeed">bikeSpeed(m/s)</label><input id="bikeSpeed" value="5"></div>
		<div><label for="bikeSwitchCost">bikeSwitchCost</label><input id="bikeSwitchCost" value="0"></div>
		<div><label for="bikeSwitchTime">bikeSwitchTime</label><input id="bikeSwitchTime" value="0"></div>
		<div>La somme des 3 suivants doit faire 1</div>
		<div><label for="slope">triangleSlopeFactor</label>0<input type="range" id="slope" value=0.33 min=0 max=1 step=0.01>1</div>
		<div><label for="secure">triangleSafetyFactor</label>0<input type="range" id="secure" value=0.33 min=0 max=1 step=0.01>1</div>
		<div><label for="fast">triangleTimeFactor</label><input type="text" id="fast" readonly value="1 moins les 2 precedents"></div>
		</div>
	</div>
	<input id="go" type="button" value="Go">
	<div id="divRes">

	</div>

    
	<a href="#" id ="showRes">Montrer les details</a>
	<a href="#" id ="hideRes">Cacher les details</a>
	<code id="codeRes" class="white-space-pre" tabindex="-1"></code>
	<div id="info"><a id="urlIti" target="_blank" href="#"></a></div>
	<script type="text/javascript" src="http://www.metromobilite.fr/js/lib/curve.min.js"></script>
	<!-- https://github.com/epistemex/cardinal-spline-js -->
    <script>
		var style = new ol.style.Style({
			fill: new ol.style.Fill({
				color: 'rgba(255, 255, 255, 0.6)'
			}),
			stroke: new ol.style.Stroke({
				color: '#319FD3',
				width: 3
			}),
		/*	image: new ol.style.Circle({
				radius: 6,
				fill: new ol.style.Fill({
					color: '#000'
				})
			}),*/
			text: new ol.style.Text({
				font: '12px Calibri,sans-serif',
				fill: new ol.style.Fill({
					color: '#000'
				}),
				stroke: new ol.style.Stroke({
					color: '#fff',
					width: 5
				})
			})
		});
		var source = new ol.source.Vector({
			format: new ol.format.GeoJSON()
		});
		var vectorLayer = new ol.layer.Vector({
			source: source,
			style: function(feature, resolution) {
			  style.getText().setText(resolution < 10 ? feature.get('LIBELLE') : '');
			  return style;
			}
		});

		var map = new ol.Map({
			layers: [
				new ol.layer.Tile({
					source: new ol.source.MapQuest({layer: 'osm'})
				}),
				vectorLayer
			],
			target: 'map',
			view: new ol.View({
				center: ol.proj.transform([5.731641,45.180645], 'EPSG:4326', 'EPSG:3857'),
				zoom: 13
			})
		});
	
		map.on('singleclick', function(evt) {
			var found =false;
			if(map.forEachFeatureAtPixel(evt.pixel, clickCarte)) {
				found=true;
			}
			if(!found) {
				var from = document.getElementById('from');
				if (!from.value) 
					from.value = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326').reverse();
				else {
					var to = document.getElementById('to');
					if(!to.value) 
						to.value = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326').reverse();
				}

			}
		});
		
		function clickCarte(feature, layer) {
		
		}
		var go = document.getElementById('go');
		go.onclick = calculIti;
		
		document.getElementById('delFrom').onclick = function(){
			document.getElementById('from').value='';
		}
		document.getElementById('delTo').onclick = function(){
			document.getElementById('to').value='';
		}
		
		function calculIti(){
			var from = document.getElementById('from');
			var to = document.getElementById('to');
			var date = document.getElementById('date');
			var time = document.getElementById('time');
			var arriveBy = document.getElementById('arriveBy');
			var bikeSpeed = document.getElementById('bikeSpeed');
			var bikeSwitchTime = document.getElementById('bikeSwitchTime');
			var bikeSwitchCost = document.getElementById('bikeSwitchCost');
			var slope = document.getElementById('slope');
			var secure = document.getElementById('secure');
			var fastValue = 1 - (parseFloat(slope.value) + parseFloat(secure.value));

			if (fastValue<0){
				alert('Valeurs slope et secure incoherentes');
				return false;
			} 
			var urlIti = 'http://data.metromobilite.fr';
			urlIti += '/api/routers/default/plan';
			urlIti += '?fromPlace='+from.value;
			urlIti += '&toPlace='+to.value;
			urlIti += '&mode=BICYCLE';
			urlIti += '&numItineraries=1';
			urlIti += '&locale=fr';
			urlIti += '&bikeSpeed='+bikeSpeed.value;
			urlIti += '&bikeSwitchTime='+bikeSwitchTime.value;
			urlIti += '&bikeSwitchCost='+bikeSwitchCost.value;
			urlIti += '&optimize=TRIANGLE';
			urlIti += '&triangleTimeFactor='+fastValue;
			urlIti += '&triangleSlopeFactor='+slope.value;
			urlIti += '&triangleSafetyFactor='+secure.value;
			urlIti += '&date='+date.value;
			urlIti += '&time='+time.value;
			urlIti += '&arriveBy='+arriveBy.value;
			
			var lienIti = document.getElementById('urlIti');
			
			lienIti.innerHTML = urlIti;
			lienIti.href = urlIti;
			
			if (from.value && to.value) {
				makeRequest(urlIti,getContent);
			}
		}
		
		function makeRequest(url,getContent) {
			httpRequest = new XMLHttpRequest();

			if (!httpRequest) {
				console.log('Giving up :( Cannot create an XMLHTTP instance');
				return false;
			}
			httpRequest.onreadystatechange = getContent;
			httpRequest.open('GET', url);
			httpRequest.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			httpRequest.send();
		}

		function getContent() {
			if (httpRequest.readyState === XMLHttpRequest.DONE) {
				if (httpRequest.status === 200) {
					var res = JSON.parse(httpRequest.responseText);
					var codeRes = document.getElementById('codeRes');
					codeRes.innerHTML = JSON.stringify(res, null, 2);

					//on purge les anciens resultats
					var divRes = document.getElementById('divRes');
					divRes.innerHTML='';
					if( res.error ) {
						divRes.innerHTML=res.error.message;
					} else {
						showGeom(res);
						showRes(res);
					}
				} else {
					alert('There was a problem with the request.');
				}
			}
		}
		function showGeom(res) {
			source.clear();
			for(var i=0;i<=res.plan.itineraries.length-1;i++) {
				for(var j=0;j<=res.plan.itineraries[i].legs.length-1;j++) {
					var geomPoly = res.plan.itineraries[i].legs[j].legGeometry.points;
					var f = (new ol.format.Polyline()).readFeature(geomPoly,{dataProjection:'EPSG:4326',featureProjection:'EPSG:3857'});
					source.addFeature(f);
				}
			}
		}
		function showRes(res) {
			var divRes = document.getElementById('divRes');
			var i = 0; // un seul iti car velo seul.
			for(var j=0;j<=res.plan.itineraries[i].legs.length-1;j++) {
				addTexte(divRes,res,i,j);
				drawProfil(divRes,res,i,j);
			}
		}
		function addTexte(divRes,res,i,j) {
			var leg = res.plan.itineraries[i].legs[j];
			var div = document.createElement('div');
			div.className="white-space-pre";
			divRes.appendChild(div);
			
			var texte = '';
			texte += 'De '+leg.from.name+' ';
			texte += new Date(leg.startTime).toLocaleTimeString()+'\r\n';
			texte += 'A '+leg.to.name+' ';
			texte += new Date(leg.endTime).toLocaleTimeString()+'\r\n';
			texte += 'Distance : '+leg.distance+' m\r\n';
			texte += 'Mode : '+leg.mode+'\r\n';

			div.innerHTML=texte;
		}
		function drawProfil(divRes,res,i,j) {
			var leg = res.plan.itineraries[i].legs[j];
			var profil = document.createElement('div');
			profil.id='profil'+j;
			var canvas = document.createElement('canvas');
			canvas.width = 600;//juste pour pouvoir retracer le canvas sans bug ???
			canvas.height= 100;
			divRes.appendChild(profil);
			profil.appendChild(canvas);
			
			var alti = {elevations:[],cumulDist:0,minElevation:99999,maxElevation:-9999,negativeElevation:0,positiveElevation:0};
			//recuperation des valeurs min, max etc...
			for (var i=0;i<leg.steps.length;i++) {
				var step=leg.steps[i];
				for (var j=0;j<leg.steps[i].elevation.length;j++) {
					alti.elevations.push(leg.steps[i].elevation[j].first+alti.cumulDist);
					alti.elevations.push(leg.steps[i].elevation[j].second);
					if (alti.minElevation>leg.steps[i].elevation[j].second) alti.minElevation=leg.steps[i].elevation[j].second;
					if (alti.maxElevation<leg.steps[i].elevation[j].second) alti.maxElevation=leg.steps[i].elevation[j].second;
					
					if (j>1) {
						var d = leg.steps[i].elevation[j].second-leg.steps[i].elevation[j-1].second;
						if (d>0)
							alti.positiveElevation += d;
						else
							alti.negativeElevation += Math.abs(d);
					}
				}
				if (leg.steps[i].elevation && leg.steps[i].elevation.length > 0)
					alti.cumulDist=alti.cumulDist+leg.steps[i].elevation[leg.steps[i].elevation.length-1].first;
				else 
					alti.cumulDist=alti.cumulDist+leg.steps[i].distance;
			}

			//tracé
				var	ctx = canvas.getContext("2d"),
				w = canvas.width,
				h = canvas.height;

			var points=[0,15];
			for (var i=0;i<alti.elevations.length;i=i+2) {
				points.push(alti.elevations[i]*(w-35)/alti.elevations[alti.elevations.length-2]);
				points.push((alti.elevations[i+1]-alti.minElevation)*(h-30)/(alti.maxElevation-alti.minElevation)+15);
			}
			points.push(points[points.length-2]);
			points.push(15);
			
			ctx.clearRect(0, 0, w, h);
			ctx.font = "10px Arial";
			ctx.fillStyle = 'black';
			ctx.strokeStyle = 'black';

			var texte = 'Dénivelé positif ' +  Math.floor(alti.positiveElevation) + ' m, ' + 'Dénivelé négatif : ' + Math.floor(alti.negativeElevation) + ' m';
			ctx.fillText(Math.floor(alti.maxElevation)+' m',w-32,12);
			ctx.fillText(Math.floor(alti.minElevation)+' m',w-32,h-3);
			ctx.fillText(texte,0/*w/2-20*/,h-3);
			
			ctx.translate(0, canvas.height);
			ctx.scale(1, -1);
			//ctx.translate(0.5, 0.5);
			ctx.lineJoin = 'round';
			
			// draw our cardinal spline
			ctx.beginPath();
			ctx.moveTo(points[0], points[1]);
			ctx.curve(points, 0, 25, false);
			ctx.strokeStyle = '#a0a0a0';
			ctx.lineWidth = 3;

			ctx.fillStyle = '#a0a0a0';
			ctx.fill();
			ctx.stroke();
		}

	  //TODO 
	  // isochrone
	  // calcul iti triangle
	  // calcul iti resultats altitude / vitesse montée / descente
	  // parametres
    </script>
  </body>
</html>